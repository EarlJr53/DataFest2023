---
title: "Lily"
output: html_document
date: "2023-04-15"
---

This is Lily's markdown file

```{r}
library(tidyverse)
library(tidycensus)
library(tidyr)
library(usmap)
library(ggplot2)
library(dplyr)
```

```{r}
attorneys <- read_csv("data/DataFest_2023_Data/attorneys.csv")

attorneys_time_entries <- read_csv("data/DataFest_2023_Data/attorneytimeentries.csv")

categories <- read_csv("data/DataFest_2023_Data/categories.csv")

clients <- read_csv("data/DataFest_2023_Data/clients.csv")

question_posts <- read_csv("data/DataFest_2023_Data/questionposts.csv")

questions <- read_csv("data/DataFest_2023_Data/questions.csv")

state_sites <- read_csv("data/DataFest_2023_Data/statesites.csv")

subcategories <- read_csv("data/DataFest_2023_Data/subcategories.csv")
```

I'm interested in the overall demographics of the clients, and also how that correlates with the type of questions that are being asked

The following focuses only on the gender. It is important to note I'm only selecting values with *one* gender value, so I'm filtering out responses from people who put down multiple genders

```{r}
clients %>%
  count(Gender)

combined <- questions %>%
  drop_na(AskedByClientUno) %>%
  right_join(clients, by = c('AskedByClientUno' = 'ClientUno'))

combined

gender_v_category <- combined %>%
  select("Category", "Gender") %>%
  group_by(Gender) %>%
  mutate(
    total_by_gender = n()
  ) %>%
  group_by(Category) %>%
  mutate(
    count = n(),
    prop = count / total_by_gender
  )

gender_v_category

# gender_v_category %>%
#   filter(Gender == c("Female", "Male")) %>%
#   ggplot() +
#     geom_col(aes(x = Category, y = prop, fill = Gender), position = "dodge") +
#     # geom_col(data = male_category, mapping = aes(Category, n), fill = "blue") +
#     coord_flip()

```

I'm going to filter the questions by keywords, because there are a lot of NA categories. The ones i'm interested in are: \_\_\_\_\_\_

```{r}

```

Other topics:

-   Smth ab incorrectly categorized questions - how this relates to proportion of unanswered questions, which categories have more flaws and should be reworded

```{r}
null_prop <- questions %>%
  left_join(clients, by = c("AskedByClientUno" = "ClientUno", "StateAbbr")) %>%
  group_by(StateAbbr) %>%
  mutate(
    is_null = 1 * (TakenByAttorneyUno == "NULL"),
  ) %>%
  count(is_null) %>%
  pivot_wider(
    names_from = "is_null",
    names_prefix = "null",
    values_from = "n"
  ) %>%
  mutate(
    null_percent = null1 / (null0 + null1)
  ) %>%
  arrange(desc(null_percent))

null_prop
```

```{r}
null_prop %>%
  ggplot() +
  geom_col(aes(StateAbbr, null_percent))
```

Try to add counties

```{r}
states_and_fips <- fips_codes %>%
  mutate(
    fips = paste0(state_code, county_code)
  ) %>%
  select(state, county, fips) %>%
  mutate(county = str_remove_all(county, " County"))

states_and_fips
```

```{r}
# combine zip and fips
questions %>%
  left_join(select(clients, -Id), by = c("StateAbbr", "AskedByClientUno" = "ClientUno")) %>%
  group_by(County, StateAbbr) %>%
  left_join(states_and_fips, by = c("County" = "county", "StateAbbr" = "state")) %>%
  filter(County == "Calhoun", StateAbbr == "AL") %>%
  select(County, StateAbbr, fips)
```

```{r}
questions_by_county <- questions %>%
  left_join(select(clients, -Id), by = c("StateAbbr", "AskedByClientUno" = "ClientUno")) %>%
  group_by(County, StateAbbr) %>%
  mutate(
    is_null = 1 * (TakenByAttorneyUno == "NULL"),
  ) %>%
  count(is_null) %>%
  pivot_wider(
    names_from = "is_null",
    names_prefix = "null",
    values_from = "n"
  ) %>%
  mutate(
    null_percent = null1 / (null0 + null1)
    # fips = fipscounty(county = counties)
    # summarise(new = list(fips(state = first(state), county = county)))
    # !state =
      # state.name[match(StateAbbr, state.abb)]
  ) %>%
  drop_na() %>%
  left_join(states_and_fips, by = c("County" = "county", "StateAbbr" = "state")) %>%
  arrange(desc(null_percent)) %>%
  drop_na()

questions_by_county
```

```{r}
plot_usmap(regions = "counties", data = questions_by_county, values = "null_percent", color = "gray") +
  scale_fill_continuous(
    low = "white", high = "red", name = "Nonresponse rate", label = scales::comma
  ) +
  labs(
    title = "Noresponse Rates by US Counties",
    # subtitle = "This is a blank map of the counties of the United States."
  ) +
  theme(legend.position = "right")

```

florida vs texas

```{r}
# florida

plot_usmap(include = c("FL", "TX"), regions = "counties", data = questions_by_county, values = "null_percent", color = "gray") +
  scale_fill_continuous(
    low = "white", high = "red", name = "Nonresponse rate", label = scales::comma
  ) +
  labs(title = "Texas vs Florida Nonresponse rates") +
  theme(legend.position = "bottom")
  
```
